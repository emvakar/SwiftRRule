name: Release

on:
  release:
    types: [published]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-latest]
        swift: ["6.0"]
    
    steps:
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ matrix.swift }}
      
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Build
        run: swift build
      
      - name: Run tests
        run: swift test

  create-release-archive:
    name: Create Release Archive
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create archive
        run: |
          tar -czf SwiftRRule-${{ github.event.release.tag_name }}.tar.gz \
            Sources/ \
            Tests/ \
            Package.swift \
            README.md \
            README.ru.md \
            LICENSE \
            CONTRIBUTING.md \
            CODE_OF_CONDUCT.md \
            CHANGELOG.md \
            SECURITY.md
      
      - name: Upload archive
        uses: actions/upload-artifact@v5
        with:
          name: SwiftRRule-${{ github.event.release.tag_name }}
          path: SwiftRRule-${{ github.event.release.tag_name }}.tar.gz

