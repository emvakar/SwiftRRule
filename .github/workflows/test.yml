name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test on ${{ matrix.os }} - Swift ${{ matrix.swift }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-latest]
        swift: ["6.0"]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ matrix.swift }}
      
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Build
        run: swift build
      
      - name: Test
        run: swift test
      
      - name: Test Results
        if: always()
        run: |
          echo "Tests completed on ${{ matrix.os }} with Swift ${{ matrix.swift }}"

  # test-ios: временно отключено
  # name: Test on iOS ${{ matrix.ios-version }}
  # runs-on: macos-latest
  # strategy:
  #   fail-fast: false
  #   matrix:
  #     ios-version: ["13", "14", "15", "16", "17", "18", "26.0"]
  #     include:
  #       - ios-version: "13"
  #         device: "iPhone 11"
  #       - ios-version: "14"
  #         device: "iPhone 12"
  #       - ios-version: "15"
  #         device: "iPhone 13"
  #       - ios-version: "16"
  #         device: "iPhone 14"
  #       - ios-version: "17"
  #         device: "iPhone 15"
  #       - ios-version: "18"
  #         device: "iPhone 16"
  #       - ios-version: "26.0"
  #         device: "iPhone 17"
  # steps:
  #   - name: Checkout
  #     uses: actions/checkout@v4
  #   
  #   - name: Setup Xcode
  #     uses: maxim-lobanov/setup-xcode@v1
  #     with:
  #       xcode-version: latest-stable
  #   
  #   - name: List available simulators
  #     run: |
  #       xcrun simctl list devices available
  #   
  #   - name: Find and boot iOS simulator
  #     run: |
  #       # Найти доступный симулятор для нужной версии iOS
  #       # Формат вывода: "iPhone 16 (6A759332-8BEA-4509-9299-2453CD3E2DEA) (Shutdown)"
  #       SIMULATOR=$(xcrun simctl list devices available | grep -i "iPhone" | grep -i "iOS ${{ matrix.ios-version }}" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
  #       
  #       if [ -z "$SIMULATOR" ]; then
  #         # Если не найден для конкретной версии, попробуем найти любой iPhone симулятор
  #         SIMULATOR=$(xcrun simctl list devices available | grep -i "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
  #       fi
  #       
  #       if [ -z "$SIMULATOR" ]; then
  #         echo "Error: No iOS simulator found"
  #         xcrun simctl list devices available
  #         exit 1
  #       fi
  #       
  #       echo "SIMULATOR_UUID=$SIMULATOR" >> $GITHUB_ENV
  #       echo "Using simulator: $SIMULATOR"
  #       
  #       # Загрузить симулятор (если еще не загружен)
  #       xcrun simctl boot "$SIMULATOR" 2>/dev/null || true
  #       
  #       # Подождать, пока симулятор загрузится
  #       sleep 10
  #       
  #       # Проверить, что симулятор загружен
  #       xcrun simctl list devices | grep "$SIMULATOR" | grep -i "Booted" || echo "Warning: Simulator may not be fully booted"
  #   
  #   - name: Build for iOS ${{ matrix.ios-version }}
  #     run: |
  #       xcodebuild -scheme SwiftRRule \
  #         -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UUID }}" \
  #         -configuration Debug \
  #         clean build
  #   
  #   - name: Test for iOS ${{ matrix.ios-version }}
  #     run: |
  #       xcodebuild test \
  #         -scheme SwiftRRule \
  #         -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UUID }}" \
  #         -configuration Debug \
  #         -enableCodeCoverage NO

  test-summary:
    name: Test Summary
    runs-on: ubuntu-22.04
    needs: [test]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All tests completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Platforms:" >> $GITHUB_STEP_SUMMARY
          echo "- macOS (latest)" >> $GITHUB_STEP_SUMMARY
          echo "- Linux (Ubuntu 22.04)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Swift Versions:" >> $GITHUB_STEP_SUMMARY
          echo "- Swift 6.0 (через swift-actions/setup-swift@v2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Setup Swift Action:" >> $GITHUB_STEP_SUMMARY
          echo "- swift-actions/setup-swift@v2" >> $GITHUB_STEP_SUMMARY

