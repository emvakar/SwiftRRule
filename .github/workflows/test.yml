name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Тестирование на Ubuntu с помощью swift test
  test-linux:
    name: Swift 6.1 on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.1"
      
      - name: Build & Test
        run: swift test

  # Тестирование на macOS с помощью swift test (используем встроенный Swift из Xcode)
  test-macos:
    name: Swift on macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Verify Swift version
        run: swift --version
      
      - name: Build & Test
        run: swift test

  # Тестирование на iOS с помощью xcodebuild (временно отключено)
  # test-ios:
  #   name: Test on iOS ${{ matrix.ios-version }}
  #   runs-on: macos-14
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - ios-version: "17.0"
  #           device: "iPhone 15"
  #         - ios-version: "18.0"
  #           device: "iPhone 16"
  #   
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     
  #     - name: Setup Xcode
  #       uses: maxim-lobanov/setup-xcode@v1
  #       with:
  #         xcode-version: latest-stable
  #     
  #     - name: List available simulators
  #       run: xcrun simctl list devices available
  #     
  #     - name: Find and boot iOS simulator
  #       id: simulator
  #       run: |
  #         # Найти доступный симулятор для нужной версии iOS
  #         # Формат вывода: "iPhone 16 (6A759332-8BEA-4509-9299-2453CD3E2DEA) (Shutdown)"
  #         SIMULATOR=$(xcrun simctl list devices available | grep -i "${{ matrix.device }}" | grep -i "iOS ${{ matrix.ios-version }}" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
  #         
  #         if [ -z "$SIMULATOR" ]; then
  #           # Если не найден для конкретной версии, попробуем найти любой iPhone симулятор с похожей версией
  #           SIMULATOR=$(xcrun simctl list devices available | grep -i "${{ matrix.device }}" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
  #         fi
  #         
  #         if [ -z "$SIMULATOR" ]; then
  #           # Если все еще не найден, попробуем найти любой iPhone симулятор
  #           SIMULATOR=$(xcrun simctl list devices available | grep -i "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
  #         fi
  #         
  #         if [ -z "$SIMULATOR" ]; then
  #           echo "Error: No iOS simulator found"
  #           xcrun simctl list devices available
  #           exit 1
  #         fi
  #         
  #         echo "SIMULATOR_UUID=$SIMULATOR" >> $GITHUB_ENV
  #         echo "Using simulator: $SIMULATOR"
  #         
  #         # Загрузить симулятор (если еще не загружен)
  #         xcrun simctl boot "$SIMULATOR" 2>/dev/null || true
  #         
  #         # Подождать, пока симулятор загрузится
  #         timeout 60 bash -c "until xcrun simctl list devices | grep \"$SIMULATOR\" | grep -i \"Booted\"; do sleep 2; done" || true
  #     
  #     - name: Build for iOS ${{ matrix.ios-version }}
  #       env:
  #         SIMULATOR_UUID: ${{ env.SIMULATOR_UUID }}
  #       run: |
  #         xcodebuild -scheme SwiftRRule \
  #           -destination "platform=iOS Simulator,id=$SIMULATOR_UUID" \
  #           -configuration Debug \
  #           clean build \
  #           CODE_SIGNING_ALLOWED=NO
  #     
  #     - name: Test for iOS ${{ matrix.ios-version }}
  #       env:
  #         SIMULATOR_UUID: ${{ env.SIMULATOR_UUID }}
  #       run: |
  #         xcodebuild test \
  #           -scheme SwiftRRule \
  #           -destination "platform=iOS Simulator,id=$SIMULATOR_UUID" \
  #           -configuration Debug \
  #           -enableCodeCoverage NO \
  #           CODE_SIGNING_ALLOWED=NO

  # Сводка результатов тестирования
  test-summary:
    name: Test Summary
    runs-on: ubuntu-22.04
    needs: [test-linux, test-macos]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-linux.result }}" == "success" ] && [ "${{ needs.test-macos.result }}" == "success" ]; then
            echo "✅ All tests completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Platforms:" >> $GITHUB_STEP_SUMMARY
          echo "- macOS 14" >> $GITHUB_STEP_SUMMARY
          echo "- Linux (Ubuntu 22.04)" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: временно отключено" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Swift Versions:" >> $GITHUB_STEP_SUMMARY
          echo "- Swift 6.0 (Ubuntu)" >> $GITHUB_STEP_SUMMARY
          echo "- Swift из Xcode (macOS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Linux: ${{ needs.test-linux.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.test-macos.result }}" >> $GITHUB_STEP_SUMMARY

