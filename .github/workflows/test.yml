name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test on ${{ matrix.os }} - Swift ${{ matrix.swift }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04]
        swift: ["6.0"]
        include:
          - os: macos-latest
            platform: "macOS"
          - os: ubuntu-22.04
            platform: "Linux"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2.3.0
        with:
          swift-version: ${{ matrix.swift }}
      
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Build
        run: swift build
      
      - name: Test
        run: swift test
      
      - name: Test Results
        if: always()
        run: |
          echo "Tests completed on ${{ matrix.platform }} with Swift ${{ matrix.swift }}"

  test-ios:
    name: Test on iOS ${{ matrix.ios-version }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        ios-version: ["13", "14", "15", "16", "17", "18", "26.0"]
        include:
          - ios-version: "13"
            device: "iPhone 11"
          - ios-version: "14"
            device: "iPhone 12"
          - ios-version: "15"
            device: "iPhone 13"
          - ios-version: "16"
            device: "iPhone 14"
          - ios-version: "17"
            device: "iPhone 15"
          - ios-version: "18"
            device: "iPhone 16"
          - ios-version: "26.0"
            device: "iPhone 17"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2.3.0
        with:
          swift-version: "6.0"
      
      - name: List available simulators
        run: |
          xcrun simctl list devices available
      
      - name: Build for iOS ${{ matrix.ios-version }}
        run: |
          xcodebuild -scheme SwiftRRule \
            -destination "platform=iOS Simulator,name=${{ matrix.device }}" \
            -configuration Debug \
            clean build
      
      - name: Test for iOS ${{ matrix.ios-version }}
        run: |
          xcodebuild test \
            -scheme SwiftRRule \
            -destination "platform=iOS Simulator,name=${{ matrix.device }}" \
            -configuration Debug \
            -enableCodeCoverage NO

  test-summary:
    name: Test Summary
    runs-on: ubuntu-22.04
    needs: [test, test-ios]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Platforms:" >> $GITHUB_STEP_SUMMARY
          echo "- macOS (latest)" >> $GITHUB_STEP_SUMMARY
          echo "- Linux (Ubuntu 22.04)" >> $GITHUB_STEP_SUMMARY
          echo "- iOS 13-18" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Swift Versions:" >> $GITHUB_STEP_SUMMARY
          echo "- Swift 6.0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Setup Swift Action:" >> $GITHUB_STEP_SUMMARY
          echo "- swift-actions/setup-swift@v2.3.0" >> $GITHUB_STEP_SUMMARY

